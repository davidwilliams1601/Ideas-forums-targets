<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideas Forums - Dashboard with Ticket Tailor Integration</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    <style>
        .chart-container { 
            position: relative; 
            height: 400px; 
            width: 100%;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .sync-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const IdeasForumsDashboard = () => {
            const [view, setView] = useState('overview');
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('ticketTailorApiKey') || '');
            const [apiKeyInput, setApiKeyInput] = useState('');
            const [lastSync, setLastSync] = useState(() => localStorage.getItem('lastSync') || null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncError, setSyncError] = useState(null);
            
            // Event mappings - maps Ticket Tailor event IDs to Ideas Forums events
            const [eventMappings, setEventMappings] = useState(() => {
                const saved = localStorage.getItem('eventMappings');
                return saved ? JSON.parse(saved) : {
                    ideasFest: '',
                    uksuaRegionals: '',
                    uksuaNationals: '',
                    gbea: '',
                    gbia: '',
                    fgi: ''
                };
            });
            
            const [ticketTailorEvents, setTicketTailorEvents] = useState([]);
            
            const [actuals, setActuals] = useState(() => {
                const saved = localStorage.getItem('ideasForumsActuals');
                return saved ? JSON.parse(saved) : {
                    ideasFest: { tickets: 800, sponsors: 0, revenue: 0 },
                    uksuaRegionals: { tickets: 0, sponsors: 0, revenue: 0 },
                    uksuaNationals: { tickets: 0, sponsors: 0, revenue: 0 },
                    gbea: { tickets: 0, sponsors: 0, revenue: 0 },
                    gbia: { tickets: 0, sponsors: 0, revenue: 0 },
                    fgi: { tickets: 0, sponsors: 0, revenue: 0 },
                    ideasCommunity: { members: 0, revenue: 0 },
                    vcCollab: { revenue: 0 },
                    website: { revenue: 0 }
                };
            });

            // Annual targets (from your previous dashboard)
            const targets = {
                ideasFest: 3100000,
                uksuaRegionals: 1852500,
                uksuaNationals: 1275000,
                gbea: 2000000,
                gbia: 1800000,
                fgi: 750000,
                ideasCommunity: 3040000,
                vcCollab: 2500000,
                website: 30000
            };

            // Monthly distribution (simplified - you can make this more detailed)
            const getMonthlyTarget = (eventKey, month) => {
                const distributions = {
                    ideasFest: [0, 0, 0, 0, 0, 0.2, 0.3, 0.3, 0.2, 0, 0, 0],
                    uksuaRegionals: [0, 0, 0, 0, 0.3, 0.4, 0.3, 0, 0, 0, 0, 0],
                    uksuaNationals: [0, 0, 0, 0, 0, 0, 0.5, 0.5, 0, 0, 0, 0],
                    gbea: [0, 0.1, 0.1, 0.1, 0.1, 0.1, 0.1, 0.2, 0.2, 0.1, 0.1, 0.1],
                    gbia: [0.1, 0.2, 0.3, 0.4, 0, 0, 0, 0, 0, 0, 0, 0],
                    fgi: [0, 0, 0, 0, 0, 0, 0, 0, 0.3, 0.4, 0.3, 0],
                    ideasCommunity: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.5, 0.5],
                    vcCollab: [0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.12],
                    website: [0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.08, 0.12]
                };
                return Math.round(targets[eventKey] * (distributions[eventKey]?.[month] || 0));
            };

            useEffect(() => {
                localStorage.setItem('ideasForumsActuals', JSON.stringify(actuals));
            }, [actuals]);

            useEffect(() => {
                localStorage.setItem('eventMappings', JSON.stringify(eventMappings));
            }, [eventMappings]);

            const saveApiKey = () => {
                localStorage.setItem('ticketTailorApiKey', apiKeyInput);
                setApiKey(apiKeyInput);
                setApiKeyInput('');
            };

            const fetchTicketTailorEvents = async () => {
                if (!apiKey) return;
                
                try {
                    const response = await fetch('https://api.tickettailor.com/v1/events', {
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': 'Basic ' + btoa(apiKey + ':')
                        }
                    });
                    
                    if (!response.ok) throw new Error('Failed to fetch events');
                    
                    const data = await response.json();
                    setTicketTailorEvents(data.data || []);
                } catch (error) {
                    console.error('Error fetching Ticket Tailor events:', error);
                    setSyncError('Failed to fetch events from Ticket Tailor');
                }
            };

            const syncTicketData = async () => {
                if (!apiKey) {
                    setSyncError('Please configure your Ticket Tailor API key first');
                    return;
                }
                
                setIsSyncing(true);
                setSyncError(null);
                
                try {
                    const newActuals = { ...actuals };
                    
                    // Fetch issued tickets for each mapped event
                    for (const [eventKey, ttEventId] of Object.entries(eventMappings)) {
                        if (!ttEventId) continue;
                        
                        try {
                            // Fetch issued tickets for this event
                            const response = await fetch(`https://api.tickettailor.com/v1/issued_tickets?event_id=${ttEventId}`, {
                                headers: {
                                    'Accept': 'application/json',
                                    'Authorization': 'Basic ' + btoa(apiKey + ':')
                                }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                const ticketCount = data.data?.length || 0;
                                
                                // Update ticket count
                                if (newActuals[eventKey]) {
                                    newActuals[eventKey].tickets = ticketCount;
                                }
                            }
                            
                            // Also fetch orders to get revenue data
                            const ordersResponse = await fetch(`https://api.tickettailor.com/v1/orders?event_id=${ttEventId}`, {
                                headers: {
                                    'Accept': 'application/json',
                                    'Authorization': 'Basic ' + btoa(apiKey + ':')
                                }
                            });
                            
                            if (ordersResponse.ok) {
                                const ordersData = await ordersResponse.json();
                                const totalRevenue = ordersData.data?.reduce((sum, order) => {
                                    return sum + (order.total || 0);
                                }, 0) || 0;
                                
                                // Update revenue (convert from cents to pounds)
                                if (newActuals[eventKey]) {
                                    newActuals[eventKey].revenue = totalRevenue / 100;
                                }
                            }
                        } catch (error) {
                            console.error(`Error fetching data for ${eventKey}:`, error);
                        }
                    }
                    
                    setActuals(newActuals);
                    const now = new Date().toISOString();
                    setLastSync(now);
                    localStorage.setItem('lastSync', now);
                    
                } catch (error) {
                    console.error('Sync error:', error);
                    setSyncError('Failed to sync with Ticket Tailor: ' + error.message);
                } finally {
                    setIsSyncing(false);
                }
            };

            useEffect(() => {
                if (apiKey && view === 'settings') {
                    fetchTicketTailorEvents();
                }
            }, [apiKey, view]);

            const calculateProgress = (eventKey) => {
                const target = targets[eventKey];
                const actual = actuals[eventKey]?.revenue || 0;
                return {
                    target,
                    actual,
                    percentage: target > 0 ? (actual / target * 100).toFixed(1) : 0,
                    variance: actual - target
                };
            };

            const getTotalProgress = () => {
                const totalTarget = Object.values(targets).reduce((a, b) => a + b, 0);
                const totalActual = Object.entries(actuals).reduce((sum, [key, value]) => {
                    return sum + (value.revenue || 0);
                }, 0);
                
                return {
                    target: totalTarget,
                    actual: totalActual,
                    percentage: (totalActual / totalTarget * 100).toFixed(1),
                    variance: totalActual - totalTarget
                };
            };

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-GB', {
                    style: 'currency',
                    currency: 'GBP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            };

            const getProgressColor = (percentage) => {
                if (percentage >= 100) return 'bg-green-500';
                if (percentage >= 75) return 'bg-blue-500';
                if (percentage >= 50) return 'bg-orange-500';
                return 'bg-red-500';
            };

            const eventLabels = {
                ideasFest: 'Ideas Fest',
                uksuaRegionals: 'UKSUA Regionals',
                uksuaNationals: 'UKSUA Nationals',
                gbea: 'Great British Entrepreneur Awards',
                gbia: 'Great British Industry Awards',
                fgi: 'Fast Growth Index',
                ideasCommunity: 'Ideas Community',
                vcCollab: 'VC Collab',
                website: 'Website'
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 shadow-lg">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold">Ideas Forums Revenue Dashboard</h1>
                                    <p className="text-purple-100 mt-1">Annual Target: {formatCurrency(13275000)} â€¢ FY 2025-2026</p>
                                </div>
                                <div className="flex items-center gap-4">
                                    {lastSync && (
                                        <div className="text-sm text-purple-100">
                                            Last sync: {new Date(lastSync).toLocaleString()}
                                        </div>
                                    )}
                                    <button
                                        onClick={syncTicketData}
                                        disabled={isSyncing || !apiKey}
                                        className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                                            isSyncing 
                                                ? 'bg-purple-300 cursor-not-allowed' 
                                                : apiKey 
                                                    ? 'bg-white text-purple-600 hover:bg-purple-50'
                                                    : 'bg-gray-300 cursor-not-allowed'
                                        }`}
                                    >
                                        <span className={isSyncing ? 'sync-pulse' : ''}>ðŸ”„</span>
                                        {isSyncing ? 'Syncing...' : 'Sync Now'}
                                    </button>
                                </div>
                            </div>
                            {syncError && (
                                <div className="mt-2 bg-red-500 text-white px-4 py-2 rounded">
                                    {syncError}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-6">
                            <div className="flex space-x-8">
                                {['overview', 'actuals', 'settings', 'targets'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setView(tab)}
                                        className={`py-4 px-2 font-medium border-b-2 transition-colors ${
                                            view === tab
                                                ? 'border-purple-600 text-purple-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="max-w-7xl mx-auto p-6">
                        {view === 'overview' && (
                            <div className="space-y-6">
                                {/* Total Progress Card */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-2xl font-bold mb-4">Overall Progress</h2>
                                    {(() => {
                                        const progress = getTotalProgress();
                                        return (
                                            <div>
                                                <div className="grid grid-cols-3 gap-4 mb-4">
                                                    <div>
                                                        <p className="text-gray-600">Target</p>
                                                        <p className="text-2xl font-bold">{formatCurrency(progress.target)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Actual</p>
                                                        <p className="text-2xl font-bold text-blue-600">{formatCurrency(progress.actual)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Variance</p>
                                                        <p className={`text-2xl font-bold ${progress.variance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {formatCurrency(Math.abs(progress.variance))}
                                                            <span className="text-sm ml-1">{progress.variance >= 0 ? 'â†‘' : 'â†“'}</span>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-8">
                                                    <div 
                                                        className={`${getProgressColor(progress.percentage)} h-8 rounded-full progress-bar flex items-center justify-center text-white font-bold`}
                                                        style={{ width: `${Math.min(progress.percentage, 100)}%` }}
                                                    >
                                                        {progress.percentage}%
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>

                                {/* Individual Event Progress */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {Object.keys(targets).map(eventKey => {
                                        const progress = calculateProgress(eventKey);
                                        return (
                                            <div key={eventKey} className="bg-white rounded-lg shadow p-6">
                                                <h3 className="font-bold text-lg mb-3">{eventLabels[eventKey]}</h3>
                                                <div className="space-y-2 mb-4">
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Target:</span>
                                                        <span className="font-semibold">{formatCurrency(progress.target)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Actual:</span>
                                                        <span className="font-semibold text-blue-600">{formatCurrency(progress.actual)}</span>
                                                    </div>
                                                    {actuals[eventKey]?.tickets !== undefined && (
                                                        <div className="flex justify-between text-sm">
                                                            <span className="text-gray-600">Tickets Sold:</span>
                                                            <span className="font-semibold">{actuals[eventKey].tickets}</span>
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-6">
                                                    <div 
                                                        className={`${getProgressColor(progress.percentage)} h-6 rounded-full progress-bar flex items-center justify-center text-white text-sm font-semibold`}
                                                        style={{ width: `${Math.min(progress.percentage, 100)}%` }}
                                                    >
                                                        {progress.percentage}%
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'actuals' && (
                            <div className="space-y-6">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-blue-800">
                                        <strong>Note:</strong> Ticket numbers are automatically synced from Ticket Tailor. 
                                        Use the fields below to manually enter sponsors, members, and other revenue data.
                                    </p>
                                </div>

                                {Object.keys(targets).map(eventKey => (
                                    <div key={eventKey} className="bg-white rounded-lg shadow p-6">
                                        <h3 className="font-bold text-lg mb-4">{eventLabels[eventKey]}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {actuals[eventKey]?.tickets !== undefined && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Tickets Sold (Auto-synced)
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={actuals[eventKey].tickets}
                                                        disabled
                                                        className="w-full px-4 py-2 border rounded-lg bg-gray-100"
                                                    />
                                                </div>
                                            )}
                                            {actuals[eventKey]?.sponsors !== undefined && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Sponsors Secured
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={actuals[eventKey].sponsors}
                                                        onChange={(e) => setActuals({
                                                            ...actuals,
                                                            [eventKey]: {
                                                                ...actuals[eventKey],
                                                                sponsors: parseInt(e.target.value) || 0
                                                            }
                                                        })}
                                                        className="w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                            )}
                                            {actuals[eventKey]?.members !== undefined && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Members Signed Up
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={actuals[eventKey].members}
                                                        onChange={(e) => setActuals({
                                                            ...actuals,
                                                            [eventKey]: {
                                                                ...actuals[eventKey],
                                                                members: parseInt(e.target.value) || 0
                                                            }
                                                        })}
                                                        className="w-full px-4 py-2 border rounded-lg"
                                                    />
                                                </div>
                                            )}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Additional Revenue (Â£)
                                                </label>
                                                <input
                                                    type="number"
                                                    value={actuals[eventKey].revenue}
                                                    onChange={(e) => setActuals({
                                                        ...actuals,
                                                        [eventKey]: {
                                                            ...actuals[eventKey],
                                                            revenue: parseFloat(e.target.value) || 0
                                                        }
                                                    })}
                                                    className="w-full px-4 py-2 border rounded-lg"
                                                    placeholder="Enter total revenue"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="space-y-6">
                                {/* API Key Configuration */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="font-bold text-lg mb-4">Ticket Tailor API Configuration</h3>
                                    
                                    {!apiKey ? (
                                        <div>
                                            <p className="text-gray-600 mb-4">
                                                Enter your Ticket Tailor API key to enable automatic ticket syncing.
                                                <a href="https://help.tickettailor.com/en/articles/4593218-how-do-i-connect-to-the-ticket-tailor-api" 
                                                   target="_blank" 
                                                   className="text-blue-600 hover:underline ml-2">
                                                    How to get your API key â†’
                                                </a>
                                            </p>
                                            <div className="flex gap-2">
                                                <input
                                                    type="password"
                                                    value={apiKeyInput}
                                                    onChange={(e) => setApiKeyInput(e.target.value)}
                                                    placeholder="sk_xxxx_xxxx_xxxxxxxxxx"
                                                    className="flex-1 px-4 py-2 border rounded-lg"
                                                />
                                                <button
                                                    onClick={saveApiKey}
                                                    className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                                                >
                                                    Save
                                                </button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div>
                                            <div className="flex items-center justify-between mb-4">
                                                <p className="text-green-600">âœ“ API key configured</p>
                                                <button
                                                    onClick={() => {
                                                        localStorage.removeItem('ticketTailorApiKey');
                                                        setApiKey('');
                                                    }}
                                                    className="text-red-600 hover:underline"
                                                >
                                                    Remove API key
                                                </button>
                                            </div>
                                        </div>
                                    )}
                                </div>

                                {/* Event Mappings */}
                                {apiKey && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="font-bold text-lg mb-4">Event Mappings</h3>
                                        <p className="text-gray-600 mb-4">
                                            Map your Ticket Tailor events to Ideas Forums programs for automatic syncing.
                                        </p>
                                        
                                        <button
                                            onClick={fetchTicketTailorEvents}
                                            className="mb-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                                        >
                                            Refresh Events List
                                        </button>

                                        <div className="space-y-4">
                                            {Object.entries(eventLabels).map(([eventKey, label]) => {
                                                if (!actuals[eventKey]?.tickets === undefined && eventKey !== 'ideasFest' && eventKey !== 'uksuaRegionals' && eventKey !== 'uksuaNationals' && eventKey !== 'gbea' && eventKey !== 'gbia' && eventKey !== 'fgi') {
                                                    return null;
                                                }
                                                
                                                return (
                                                    <div key={eventKey} className="flex items-center gap-4">
                                                        <label className="w-64 font-medium">{label}:</label>
                                                        <select
                                                            value={eventMappings[eventKey] || ''}
                                                            onChange={(e) => setEventMappings({
                                                                ...eventMappings,
                                                                [eventKey]: e.target.value
                                                            })}
                                                            className="flex-1 px-4 py-2 border rounded-lg"
                                                        >
                                                            <option value="">-- Select Ticket Tailor Event --</option>
                                                            {ticketTailorEvents.map(event => (
                                                                <option key={event.id} value={event.id}>
                                                                    {event.name} (ID: {event.id})
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'targets' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <h3 className="font-bold text-lg mb-4">Annual Revenue Targets</h3>
                                <div className="space-y-3">
                                    {Object.entries(targets).map(([key, value]) => (
                                        <div key={key} className="flex justify-between items-center p-3 bg-gray-50 rounded">
                                            <span className="font-medium">{eventLabels[key]}</span>
                                            <span className="font-bold text-purple-600">{formatCurrency(value)}</span>
                                        </div>
                                    ))}
                                    <div className="flex justify-between items-center p-4 bg-purple-100 rounded font-bold text-lg">
                                        <span>Total Annual Target</span>
                                        <span className="text-purple-600">{formatCurrency(Object.values(targets).reduce((a, b) => a + b, 0))}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<IdeasForumsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
