<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideas Forums - Complete Dashboard with Ticket Tailor</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <style>
        .chart-container { 
            position: relative; 
            height: 400px; 
            width: 100%;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .sync-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Migration: convert old single-API-key format to multi-box-office
        (() => {
            if (localStorage.getItem('boxOffices')) return; // already migrated

            const oldKey = localStorage.getItem('ticketTailorApiKey');
            if (oldKey) {
                const boId = 'bo_' + Date.now();
                const boxOffices = {
                    [boId]: {
                        id: boId,
                        name: 'Default Box Office',
                        platform: 'tickettailor',
                        apiKey: oldKey
                    }
                };
                localStorage.setItem('boxOffices', JSON.stringify(boxOffices));

                // Convert flat eventMappings to new format
                const rawMappings = localStorage.getItem('eventMappings');
                if (rawMappings) {
                    const old = JSON.parse(rawMappings);
                    const converted = {};
                    for (const [k, v] of Object.entries(old)) {
                        converted[k] = v ? { boxOfficeId: boId, eventId: v } : null;
                    }
                    localStorage.setItem('eventMappings', JSON.stringify(converted));
                }

                localStorage.removeItem('ticketTailorApiKey');
            } else {
                localStorage.setItem('boxOffices', JSON.stringify({}));
            }
        })();

        const IdeasForumsDashboard = () => {
            const [view, setView] = useState('overview');
            const [selectedEvent, setSelectedEvent] = useState(null);
            const [boxOffices, setBoxOffices] = useState(() => {
                const saved = localStorage.getItem('boxOffices');
                return saved ? JSON.parse(saved) : {};
            });
            const [lastSync, setLastSync] = useState(() => localStorage.getItem('lastSync') || null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [syncError, setSyncError] = useState(null);
            const [useProxy, setUseProxy] = useState(() => {
                const saved = localStorage.getItem('useProxy');
                return saved === null ? true : saved === 'true'; // Default to true for new users
            });
            const [proxyUrl, setProxyUrl] = useState(() => localStorage.getItem('proxyUrl') || 'vercel');
            
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            // Event mappings - new format: { eventKey: { boxOfficeId, eventId } | null }
            const [eventMappings, setEventMappings] = useState(() => {
                const saved = localStorage.getItem('eventMappings');
                return saved ? JSON.parse(saved) : {
                    ideasFest: null,
                    uksuaRegionals: null,
                    uksuaNationals: null,
                    gbea: null,
                    gbia: null,
                    fgi: null
                };
            });

            // Events fetched per box office: { boId: [event, ...] }
            const [ttEventsByBoxOffice, setTtEventsByBoxOffice] = useState({});

            // Add box office form state
            const [newBoName, setNewBoName] = useState('');
            const [newBoKey, setNewBoKey] = useState('');
            
            // Monthly actuals
            const [monthlyActuals, setMonthlyActuals] = useState(() => {
                const saved = localStorage.getItem('ideasForumsMonthlyActuals');
                return saved ? JSON.parse(saved) : {};
            });

            // Annual actuals
            const [actuals, setActuals] = useState(() => {
                const saved = localStorage.getItem('ideasForumsActuals');
                return saved ? JSON.parse(saved) : {
                    ideasFest: { tickets: 800, sponsors: 0, revenue: 0 },
                    uksuaRegionals: { tickets: 0, sponsors: 0, revenue: 0 },
                    uksuaNationals: { tickets: 0, sponsors: 0, revenue: 0 },
                    gbea: { tickets: 0, sponsors: 0, revenue: 0 },
                    gbia: { tickets: 0, sponsors: 0, revenue: 0 },
                    fgi: { tickets: 0, sponsors: 0, revenue: 0 },
                    ideasCommunity: { members: 0, revenue: 0 },
                    vcCollab: { revenue: 0 },
                    website: { revenue: 0 }
                };
            });

            // Sponsor deals
            const [sponsorDeals, setSponsorDeals] = useState(() => {
                const saved = localStorage.getItem('ideasForumsSponsorDeals');
                return saved ? JSON.parse(saved) : [];
            });

            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            // Default targets
            const defaultTargets = {
                ideasFest: {
                    total: 3100000,
                    breakdown: { tickets: 2700000, sponsors: 400000 },
                    monthly: [0, 0, 50000, 100000, 150000, 620000, 930000, 930000, 620000, 0, 0, 0]
                },
                uksuaRegionals: {
                    total: 1852500,
                    breakdown: { applications: 352500, sponsors: 1500000 },
                    monthly: [0, 0, 50000, 100000, 555750, 741000, 555750, 0, 0, 0, 0, 0]
                },
                uksuaNationals: {
                    total: 1275000,
                    breakdown: { tickets: 525000, sponsors: 750000 },
                    monthly: [0, 0, 0, 0, 0, 127500, 637500, 637500, 0, 0, 0, 0]
                },
                gbea: {
                    total: 2000000,
                    breakdown: { applications: 750000, tickets: 750000, sponsors: 500000 },
                    monthly: [0, 200000, 200000, 200000, 200000, 200000, 200000, 400000, 400000, 200000, 200000, 200000]
                },
                gbia: {
                    total: 1800000,
                    breakdown: { applications: 300000, tickets: 1050000, sponsors: 450000 },
                    monthly: [180000, 360000, 540000, 720000, 0, 0, 0, 0, 0, 0, 0, 0]
                },
                fgi: {
                    total: 750000,
                    breakdown: { tickets: 600000, sponsors: 150000 },
                    monthly: [0, 0, 0, 0, 0, 0, 0, 0, 225000, 300000, 225000, 0]
                },
                ideasCommunity: {
                    total: 3040000,
                    breakdown: { membership: 3040000 },
                    monthly: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1520000, 1520000]
                },
                vcCollab: {
                    total: 2500000,
                    breakdown: { partnerships: 2500000 },
                    monthly: [208333, 208333, 208333, 208333, 208333, 208333, 208333, 208333, 208333, 208333, 208333, 208337]
                },
                website: {
                    total: 30000,
                    breakdown: { advertising: 30000 },
                    monthly: [2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500, 2500]
                }
            };

            // Editable targets
            const [targets, setTargets] = useState(() => {
                const saved = localStorage.getItem('ideasForumsTargets');
                return saved ? JSON.parse(saved) : defaultTargets;
            });

            const SPONSOR_ELIGIBLE_EVENTS = ['ideasFest', 'uksuaRegionals', 'uksuaNationals', 'gbea', 'gbia', 'fgi'];

            const eventLabels = {
                ideasFest: 'Ideas Fest',
                uksuaRegionals: 'UKSUA Regionals',
                uksuaNationals: 'UKSUA Nationals',
                gbea: 'Great British Entrepreneur Awards',
                gbia: 'Great British Industry Awards',
                fgi: 'Fast Growth Index',
                ideasCommunity: 'Ideas Community',
                vcCollab: 'VC Collab',
                website: 'Website'
            };

            useEffect(() => {
                localStorage.setItem('ideasForumsActuals', JSON.stringify(actuals));
            }, [actuals]);

            useEffect(() => {
                localStorage.setItem('ideasForumsMonthlyActuals', JSON.stringify(monthlyActuals));
            }, [monthlyActuals]);

            useEffect(() => {
                localStorage.setItem('ideasForumsTargets', JSON.stringify(targets));
            }, [targets]);

            useEffect(() => {
                localStorage.setItem('eventMappings', JSON.stringify(eventMappings));
            }, [eventMappings]);

            useEffect(() => {
                localStorage.setItem('useProxy', useProxy.toString());
            }, [useProxy]);

            useEffect(() => {
                localStorage.setItem('proxyUrl', proxyUrl);
            }, [proxyUrl]);

            useEffect(() => {
                localStorage.setItem('boxOffices', JSON.stringify(boxOffices));
            }, [boxOffices]);

            useEffect(() => {
                localStorage.setItem('ideasForumsSponsorDeals', JSON.stringify(sponsorDeals));
            }, [sponsorDeals]);

            // Auto-derive sponsors count from confirmed+paid deals
            useEffect(() => {
                const newActuals = { ...actuals };
                let changed = false;
                SPONSOR_ELIGIBLE_EVENTS.forEach(eventKey => {
                    if (!newActuals[eventKey]) return;
                    const count = sponsorDeals.filter(d => d.eventKey === eventKey && (d.status === 'confirmed' || d.status === 'paid')).length;
                    if (newActuals[eventKey].sponsors !== count) {
                        newActuals[eventKey] = { ...newActuals[eventKey], sponsors: count };
                        changed = true;
                    }
                });
                if (changed) setActuals(newActuals);
            }, [sponsorDeals]);

            const hasAnyBoxOffice = Object.keys(boxOffices).length > 0;

            const resetTargets = () => {
                if (confirm('Reset all targets to default values? This cannot be undone.')) {
                    setTargets(defaultTargets);
                }
            };

            const updateTarget = (eventKey, field, value) => {
                setTargets({
                    ...targets,
                    [eventKey]: {
                        ...targets[eventKey],
                        [field]: parseFloat(value) || 0
                    }
                });
            };

            const makeApiRequest = async (endpoint, apiKeyForRequest) => {
                if (!apiKeyForRequest) throw new Error('No API key provided for this request');

                let url;
                const headers = {
                    'Accept': 'application/json'
                };

                const authString = btoa(apiKeyForRequest + ':');
                headers['Authorization'] = 'Basic ' + authString;

                if (useProxy) {
                    if (proxyUrl === 'vercel') {
                        // Use Vercel serverless function
                        url = `/api/tickettailor?endpoint=${encodeURIComponent(endpoint)}`;
                        console.log(`Using Vercel proxy`);
                    } else {
                        // Use external CORS proxy (may not work with Authorization header)
                        const baseUrl = 'https://api.tickettailor.com/v1/';
                        url = `${proxyUrl}${baseUrl}${endpoint}`;
                        console.log(`Using external proxy: ${proxyUrl}`);
                    }
                } else {
                    // Direct connection (will fail due to CORS)
                    url = `https://api.tickettailor.com/v1/${endpoint}`;
                    console.log(`Direct connection (no proxy)`);
                }

                console.log(`API Request: ${endpoint}`);
                console.log(`Full URL: ${url}`);

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: headers,
                        mode: 'cors'
                    });

                    console.log(`Response status: ${response.status}`);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API Error (${response.status}): ${errorText || response.statusText}`);
                    }

                    const data = await response.json();
                    console.log(`Response data:`, data);
                    return data;
                } catch (error) {
                    // Check for common network/CORS errors
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        throw new Error('CORS or network error. Try using the Vercel proxy or enable CORS in Settings.');
                    }
                    throw error;
                }
            };

            // Fetch all pages from a paginated TT API endpoint
            const fetchAllPages = async (endpoint, apiKeyForRequest) => {
                const PAGE_SIZE = 100;
                let allItems = [];
                let nextEndpoint = endpoint;
                let pageNum = 1;
                while (nextEndpoint) {
                    const data = await makeApiRequest(nextEndpoint, apiKeyForRequest);
                    const pageItems = data.data || [];
                    allItems = allItems.concat(pageItems);
                    console.log(`  page ${pageNum}: got ${pageItems.length} items (${allItems.length} total)`);
                    console.log(`  links:`, JSON.stringify(data.links));

                    // Try links.next first
                    const nextUrl = data.links?.next;
                    if (nextUrl) {
                        nextEndpoint = nextUrl.replace(/^\//, '');
                        console.log(`  next page via links.next: ${nextEndpoint}`);
                    } else if (pageItems.length >= PAGE_SIZE) {
                        // Fallback: manual cursor pagination using last item's ID
                        const lastId = pageItems[pageItems.length - 1]?.id;
                        if (lastId) {
                            // Preserve the base endpoint path and original query params
                            const baseEndpoint = endpoint.split('?')[0];
                            const origParams = endpoint.includes('?') ? '&' + endpoint.split('?')[1] : '';
                            nextEndpoint = `${baseEndpoint}?starting_after=${lastId}${origParams}`;
                            console.log(`  next page via cursor fallback: ${nextEndpoint}`);
                        } else {
                            nextEndpoint = null;
                        }
                    } else {
                        nextEndpoint = null;
                    }
                    pageNum++;
                }
                console.log(`  pagination complete: ${allItems.length} total items`);
                return allItems;
            };

            const fetchEventsForBoxOffice = async (boxOfficeId) => {
                const bo = boxOffices[boxOfficeId];
                if (!bo) return;

                try {
                    const data = await makeApiRequest('events', bo.apiKey);
                    setTtEventsByBoxOffice(prev => ({
                        ...prev,
                        [boxOfficeId]: data.data || []
                    }));
                    if (!data.data || data.data.length === 0) {
                        setSyncError(`No events found in "${bo.name}"`);
                    }
                } catch (error) {
                    console.error(`Error fetching events for ${bo.name}:`, error);
                    let errorMessage = `Failed to fetch events from "${bo.name}". `;

                    if (error.message.includes('CORS')) {
                        errorMessage += 'CORS error detected. Try enabling the CORS proxy in Settings.';
                    } else if (error.message.includes('401')) {
                        errorMessage += 'Invalid API key. Please check your API key.';
                    } else if (error.message.includes('403')) {
                        errorMessage += 'Access denied. Make sure your API key has the correct permissions.';
                    } else {
                        errorMessage += error.message;
                    }

                    setSyncError(errorMessage);
                }
            };

            const fetchAllBoxOfficeEvents = async () => {
                for (const boId of Object.keys(boxOffices)) {
                    await fetchEventsForBoxOffice(boId);
                }
            };

            const syncTicketData = async () => {
                console.log('üîÑ Sync button clicked');
                console.log('Box offices:', Object.keys(boxOffices).length);
                console.log('Event mappings:', eventMappings);

                if (!hasAnyBoxOffice) {
                    console.error('‚ùå No box offices configured');
                    setSyncError('Please add a box office in Settings first');
                    return;
                }

                // Check if any events are mapped
                const mappedEvents = Object.entries(eventMappings).filter(([_, m]) => m && m.eventId);
                console.log('Mapped events count:', mappedEvents.length);

                if (mappedEvents.length === 0) {
                    setSyncError('No events mapped. Please map at least one event in Settings.');
                    console.error('‚ùå No events mapped');
                    return;
                }

                setIsSyncing(true);
                setSyncError(null);
                console.log('‚úÖ Starting sync process...');

                try {
                    const newActuals = { ...actuals };
                    let successCount = 0;
                    let errorDetails = [];

                    for (const [eventKey, mapping] of mappedEvents) {
                        const bo = boxOffices[mapping.boxOfficeId];
                        if (!bo) {
                            errorDetails.push(`${eventKey}: box office not found`);
                            continue;
                        }
                        const ttEventId = mapping.eventId;

                        console.log(`üìä Syncing ${eventKey} via "${bo.name}" (ID: ${ttEventId})`);

                        try {
                            // Fetch all issued tickets (paginated)
                            try {
                                console.log(`  ‚Üí Fetching tickets for ${eventKey}...`);
                                const allTickets = await fetchAllPages(`issued_tickets?event_id=${ttEventId}`, bo.apiKey);
                                console.log(`  ‚úì Got ${allTickets.length} tickets for ${eventKey}`);

                                if (newActuals[eventKey]) {
                                    newActuals[eventKey].tickets = allTickets.length;
                                }
                            } catch (ticketsError) {
                                console.error(`  ‚úó Error fetching tickets for ${eventKey}:`, ticketsError);
                                errorDetails.push(`${eventKey} tickets (${bo.name}): ${ticketsError.message}`);
                            }

                            // Fetch all orders for revenue (paginated)
                            try {
                                console.log(`  ‚Üí Fetching orders for ${eventKey}...`);
                                const allOrders = await fetchAllPages(`orders?event_id=${ttEventId}`, bo.apiKey);
                                const totalRevenue = allOrders.reduce((sum, order) => {
                                    return sum + (order.total || 0);
                                }, 0);
                                console.log(`  ‚úì Got revenue ¬£${(totalRevenue/100).toFixed(2)} from ${allOrders.length} orders for ${eventKey}`);

                                if (newActuals[eventKey]) {
                                    newActuals[eventKey].revenue = totalRevenue / 100;
                                }
                            } catch (ordersError) {
                                console.error(`  ‚úó Error fetching orders for ${eventKey}:`, ordersError);
                                errorDetails.push(`${eventKey} orders (${bo.name}): ${ordersError.message}`);
                            }

                            successCount++;
                        } catch (error) {
                            console.error(`‚ùå Error fetching data for ${eventKey}:`, error);
                            errorDetails.push(`${eventKey} (${bo.name}): ${error.message}`);
                        }
                    }

                    console.log(`‚úÖ Successfully synced ${successCount} events`);

                    if (successCount === 0) {
                        const errorMsg = 'Failed to sync any events. ' + (errorDetails.length > 0 ? errorDetails.join('; ') : 'Please check your event mappings and box office API keys.');
                        throw new Error(errorMsg);
                    }

                    setActuals(newActuals);
                    const now = new Date().toISOString();
                    setLastSync(now);
                    localStorage.setItem('lastSync', now);

                    if (errorDetails.length > 0) {
                        setSyncError(`Partial sync completed with errors: ${errorDetails.join('; ')}`);
                    } else {
                        setSyncError(null);
                        console.log('üéâ Sync completed successfully!');
                    }

                } catch (error) {
                    console.error('‚ùå Sync error:', error);
                    setSyncError('Failed to sync with Ticket Tailor: ' + error.message);
                } finally {
                    setIsSyncing(false);
                    console.log('üèÅ Sync process finished');
                }
            };

            useEffect(() => {
                if (hasAnyBoxOffice && view === 'settings') {
                    fetchAllBoxOfficeEvents();
                }
            }, [hasAnyBoxOffice, view, useProxy, proxyUrl]);

            // Chart rendering
            useEffect(() => {
                if (view === 'overview' && chartRef.current) {
                    renderChart();
                }
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [view, actuals, targets]);

            const renderChart = () => {
                if (chartInstance.current) {
                    chartInstance.current.destroy();
                }

                const ctx = chartRef.current.getContext('2d');
                
                const eventKeys = Object.keys(targets);
                const targetData = eventKeys.map(key => targets[key].total);
                const actualData = eventKeys.map(key => actuals[key]?.revenue || 0);
                
                chartInstance.current = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: eventKeys.map(key => eventLabels[key]),
                        datasets: [
                            {
                                label: 'Target',
                                data: targetData,
                                backgroundColor: 'rgba(147, 51, 234, 0.5)',
                                borderColor: 'rgba(147, 51, 234, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Actual',
                                data: actualData,
                                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '¬£' + (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Revenue Targets vs Actuals by Stream'
                            }
                        }
                    }
                });
            };

            const calculateProgress = (eventKey) => {
                const target = targets[eventKey].total;
                const actual = actuals[eventKey]?.revenue || 0;
                return {
                    target,
                    actual,
                    percentage: target > 0 ? (actual / target * 100).toFixed(1) : 0,
                    variance: actual - target
                };
            };

            const getTotalProgress = () => {
                const totalTarget = Object.values(targets).reduce((sum, t) => sum + t.total, 0);
                const totalActual = Object.entries(actuals).reduce((sum, [key, value]) => {
                    return sum + (value.revenue || 0);
                }, 0);
                
                return {
                    target: totalTarget,
                    actual: totalActual,
                    percentage: (totalActual / totalTarget * 100).toFixed(1),
                    variance: totalActual - totalTarget
                };
            };

            const formatCurrency = (value) => {
                return new Intl.NumberFormat('en-GB', {
                    style: 'currency',
                    currency: 'GBP',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(value);
            };

            const getDealsForEvent = (eventKey) => sponsorDeals.filter(d => d.eventKey === eventKey);

            const getSponsorSummary = (eventKey) => {
                const deals = getDealsForEvent(eventKey);
                const pipeline = deals.filter(d => d.status === 'pipeline');
                const confirmed = deals.filter(d => d.status === 'confirmed');
                const paid = deals.filter(d => d.status === 'paid');
                const securedAmount = [...confirmed, ...paid].reduce((sum, d) => sum + d.amount, 0);
                const sponsorTarget = targets[eventKey]?.breakdown?.sponsors || 0;
                return {
                    pipelineCount: pipeline.length,
                    confirmedCount: confirmed.length,
                    paidCount: paid.length,
                    securedCount: confirmed.length + paid.length,
                    totalCount: deals.length,
                    pipelineAmount: pipeline.reduce((sum, d) => sum + d.amount, 0),
                    securedAmount,
                    totalAmount: deals.reduce((sum, d) => sum + d.amount, 0),
                    sponsorTarget
                };
            };

            const addDeal = (eventKey) => {
                setSponsorDeals([...sponsorDeals, {
                    id: 'deal_' + Date.now(),
                    eventKey,
                    company: '',
                    amount: 0,
                    status: 'pipeline'
                }]);
            };

            const updateDeal = (dealId, updates) => {
                setSponsorDeals(sponsorDeals.map(d => d.id === dealId ? { ...d, ...updates } : d));
            };

            const deleteDeal = (dealId) => {
                if (confirm('Delete this sponsorship deal?')) {
                    setSponsorDeals(sponsorDeals.filter(d => d.id !== dealId));
                }
            };

            const getProgressColor = (percentage) => {
                if (percentage >= 100) return 'bg-green-500';
                if (percentage >= 75) return 'bg-blue-500';
                if (percentage >= 50) return 'bg-orange-500';
                return 'bg-red-500';
            };

            const getMonthlyActual = (eventKey, monthIndex) => {
                return monthlyActuals[`${eventKey}_${monthIndex}`] || 0;
            };

            const setMonthlyActual = (eventKey, monthIndex, value) => {
                setMonthlyActuals({
                    ...monthlyActuals,
                    [`${eventKey}_${monthIndex}`]: value
                });
            };

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <div className="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6 shadow-lg">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h1 className="text-3xl font-bold">Ideas Forums Revenue Dashboard</h1>
                                    <p className="text-purple-100 mt-1">
                                        Annual Target: {formatCurrency(Object.values(targets).reduce((sum, t) => sum + t.total, 0))} ‚Ä¢ FY 2025-2026
                                    </p>
                                </div>
                                <div className="flex items-center gap-4">
                                    {lastSync && (
                                        <div className="text-sm text-purple-100">
                                            Last sync: {new Date(lastSync).toLocaleString()}
                                        </div>
                                    )}
                                    <button
                                        onClick={syncTicketData}
                                        disabled={isSyncing || !hasAnyBoxOffice}
                                        className={`px-4 py-2 rounded-lg flex items-center gap-2 ${
                                            isSyncing
                                                ? 'bg-purple-300 cursor-not-allowed'
                                                : hasAnyBoxOffice
                                                    ? 'bg-white text-purple-600 hover:bg-purple-50'
                                                    : 'bg-gray-300 cursor-not-allowed'
                                        }`}
                                    >
                                        <span className={isSyncing ? 'sync-pulse' : ''}>üîÑ</span>
                                        {isSyncing ? 'Syncing...' : 'Sync Ticket Tailor'}
                                    </button>
                                </div>
                            </div>
                            {syncError && (
                                <div className="mt-2 bg-red-500 text-white px-4 py-2 rounded">
                                    ‚ö†Ô∏è {syncError}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="bg-white shadow-sm border-b">
                        <div className="max-w-7xl mx-auto px-6">
                            <div className="flex space-x-8">
                                {['overview', 'monthly', 'actuals', 'targets', 'settings'].map(tab => (
                                    <button
                                        key={tab}
                                        onClick={() => setView(tab)}
                                        className={`py-4 px-2 font-medium border-b-2 transition-colors ${
                                            view === tab
                                                ? 'border-purple-600 text-purple-600'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        {tab.charAt(0).toUpperCase() + tab.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="max-w-7xl mx-auto p-6">
                        {view === 'overview' && (
                            <div className="space-y-6">
                                {/* Total Progress Card */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-2xl font-bold mb-4">Overall Progress</h2>
                                    {(() => {
                                        const progress = getTotalProgress();
                                        return (
                                            <div>
                                                <div className="grid grid-cols-3 gap-4 mb-4">
                                                    <div>
                                                        <p className="text-gray-600">Target</p>
                                                        <p className="text-2xl font-bold">{formatCurrency(progress.target)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Actual</p>
                                                        <p className="text-2xl font-bold text-blue-600">{formatCurrency(progress.actual)}</p>
                                                    </div>
                                                    <div>
                                                        <p className="text-gray-600">Variance</p>
                                                        <p className={`text-2xl font-bold ${progress.variance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {formatCurrency(Math.abs(progress.variance))}
                                                            <span className="text-sm ml-1">{progress.variance >= 0 ? '‚Üë' : '‚Üì'}</span>
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-8">
                                                    <div 
                                                        className={`${getProgressColor(progress.percentage)} h-8 rounded-full progress-bar flex items-center justify-center text-white font-bold`}
                                                        style={{ width: `${Math.min(progress.percentage, 100)}%` }}
                                                    >
                                                        {progress.percentage}%
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>

                                {/* Chart */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <div className="chart-container">
                                        <canvas ref={chartRef}></canvas>
                                    </div>
                                </div>

                                {/* Individual Event Progress */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {Object.keys(targets).map(eventKey => {
                                        const progress = calculateProgress(eventKey);
                                        return (
                                            <div key={eventKey} className="bg-white rounded-lg shadow p-6">
                                                <h3 className="font-bold text-lg mb-3">{eventLabels[eventKey]}</h3>
                                                <div className="space-y-2 mb-4">
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Target:</span>
                                                        <span className="font-semibold">{formatCurrency(progress.target)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-sm">
                                                        <span className="text-gray-600">Actual:</span>
                                                        <span className="font-semibold text-blue-600">{formatCurrency(progress.actual)}</span>
                                                    </div>
                                                    {actuals[eventKey]?.tickets !== undefined && (
                                                        <div className="flex justify-between text-sm">
                                                            <span className="text-gray-600">Tickets Sold:</span>
                                                            <span className="font-semibold">{actuals[eventKey].tickets}</span>
                                                        </div>
                                                    )}
                                                    {SPONSOR_ELIGIBLE_EVENTS.includes(eventKey) && (() => {
                                                        const ss = getSponsorSummary(eventKey);
                                                        if (ss.totalCount === 0 && !ss.sponsorTarget) return null;
                                                        return (
                                                            <>
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-600">Sponsors:</span>
                                                                    <span className="font-semibold">
                                                                        {ss.securedCount} secured{ss.pipelineCount > 0 ? ` (${ss.pipelineCount} pipeline)` : ''}
                                                                    </span>
                                                                </div>
                                                                {ss.sponsorTarget > 0 && (
                                                                    <div>
                                                                        <div className="flex justify-between text-xs text-gray-500 mb-1">
                                                                            <span>{formatCurrency(ss.securedAmount)} secured</span>
                                                                            <span>{formatCurrency(ss.sponsorTarget)} target</span>
                                                                        </div>
                                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                                            <div
                                                                                className="bg-purple-500 h-2 rounded-full progress-bar"
                                                                                style={{ width: `${Math.min((ss.securedAmount / ss.sponsorTarget) * 100, 100)}%` }}
                                                                            />
                                                                        </div>
                                                                    </div>
                                                                )}
                                                            </>
                                                        );
                                                    })()}
                                                </div>
                                                <div className="w-full bg-gray-200 rounded-full h-6">
                                                    <div 
                                                        className={`${getProgressColor(progress.percentage)} h-6 rounded-full progress-bar flex items-center justify-center text-white text-sm font-semibold`}
                                                        style={{ width: `${Math.min(progress.percentage, 100)}%` }}
                                                    >
                                                        {progress.percentage}%
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {view === 'monthly' && (
                            <div className="space-y-6">
                                {/* Event Selector */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="font-bold text-lg mb-4">Select Event for Monthly Breakdown</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        {Object.keys(targets).map(eventKey => (
                                            <button
                                                key={eventKey}
                                                onClick={() => setSelectedEvent(eventKey)}
                                                className={`p-4 rounded-lg border-2 transition-colors ${
                                                    selectedEvent === eventKey
                                                        ? 'border-purple-600 bg-purple-50'
                                                        : 'border-gray-200 hover:border-purple-300'
                                                }`}
                                            >
                                                <div className="font-semibold">{eventLabels[eventKey]}</div>
                                                <div className="text-sm text-gray-600">{formatCurrency(targets[eventKey].total)}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Monthly Breakdown Table */}
                                {selectedEvent && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="font-bold text-lg mb-4">
                                            {eventLabels[selectedEvent]} - Monthly Targets & Actuals
                                        </h3>
                                        <div className="overflow-x-auto">
                                            <table className="w-full">
                                                <thead>
                                                    <tr className="border-b-2">
                                                        <th className="text-left py-3 px-4">Month</th>
                                                        <th className="text-right py-3 px-4">Target</th>
                                                        <th className="text-right py-3 px-4">Actual</th>
                                                        <th className="text-right py-3 px-4">Variance</th>
                                                        <th className="text-right py-3 px-4">%</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {targets[selectedEvent].monthly.map((monthTarget, index) => {
                                                        const actual = getMonthlyActual(selectedEvent, index);
                                                        const variance = actual - monthTarget;
                                                        const percentage = monthTarget > 0 ? ((actual / monthTarget) * 100).toFixed(1) : 0;
                                                        
                                                        return (
                                                            <tr key={index} className="border-b hover:bg-gray-50">
                                                                <td className="py-3 px-4 font-medium">{months[index]}</td>
                                                                <td className="py-3 px-4 text-right">{formatCurrency(monthTarget)}</td>
                                                                <td className="py-3 px-4 text-right">
                                                                    <input
                                                                        type="number"
                                                                        value={actual}
                                                                        onChange={(e) => setMonthlyActual(selectedEvent, index, parseFloat(e.target.value) || 0)}
                                                                        className="w-32 px-2 py-1 border rounded text-right"
                                                                    />
                                                                </td>
                                                                <td className={`py-3 px-4 text-right font-semibold ${variance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                    {formatCurrency(Math.abs(variance))}
                                                                    <span className="text-xs ml-1">{variance >= 0 ? '‚Üë' : '‚Üì'}</span>
                                                                </td>
                                                                <td className="py-3 px-4 text-right">{percentage}%</td>
                                                            </tr>
                                                        );
                                                    })}
                                                    <tr className="bg-purple-50 font-bold">
                                                        <td className="py-3 px-4">Total</td>
                                                        <td className="py-3 px-4 text-right">{formatCurrency(targets[selectedEvent].total)}</td>
                                                        <td className="py-3 px-4 text-right">
                                                            {formatCurrency(targets[selectedEvent].monthly.reduce((sum, _, index) => sum + getMonthlyActual(selectedEvent, index), 0))}
                                                        </td>
                                                        <td className="py-3 px-4 text-right">
                                                            {(() => {
                                                                const totalActual = targets[selectedEvent].monthly.reduce((sum, _, index) => sum + getMonthlyActual(selectedEvent, index), 0);
                                                                const totalVariance = totalActual - targets[selectedEvent].total;
                                                                return (
                                                                    <span className={totalVariance >= 0 ? 'text-green-600' : 'text-red-600'}>
                                                                        {formatCurrency(Math.abs(totalVariance))}
                                                                        <span className="text-xs ml-1">{totalVariance >= 0 ? '‚Üë' : '‚Üì'}</span>
                                                                    </span>
                                                                );
                                                            })()}
                                                        </td>
                                                        <td className="py-3 px-4 text-right">
                                                            {(() => {
                                                                const totalActual = targets[selectedEvent].monthly.reduce((sum, _, index) => sum + getMonthlyActual(selectedEvent, index), 0);
                                                                return ((totalActual / targets[selectedEvent].total) * 100).toFixed(1);
                                                            })()}%
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>

                                        {/* Revenue Breakdown */}
                                        <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                                            <h4 className="font-semibold mb-3">Revenue Breakdown</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                {Object.entries(targets[selectedEvent].breakdown).map(([key, value]) => (
                                                    <div key={key} className="flex justify-between">
                                                        <span className="capitalize">{key}:</span>
                                                        <span className="font-semibold">{formatCurrency(value)}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {view === 'actuals' && (
                            <div className="space-y-6">
                                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <p className="text-blue-800">
                                        <strong>üí° Note:</strong> Ticket numbers are automatically synced from Ticket Tailor. 
                                        Use the fields below to manually enter sponsors, members, and other revenue data.
                                    </p>
                                </div>

                                {Object.keys(targets).map(eventKey => (
                                    <div key={eventKey} className="bg-white rounded-lg shadow p-6">
                                        <h3 className="font-bold text-lg mb-4">{eventLabels[eventKey]}</h3>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            {actuals[eventKey] && actuals[eventKey].tickets !== undefined && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Tickets Sold (Auto-synced) üé´
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={actuals[eventKey].tickets || 0}
                                                        disabled
                                                        className="w-full px-4 py-2 border rounded-lg bg-gray-100 text-gray-600"
                                                    />
                                                </div>
                                            )}
                                            {actuals[eventKey] && actuals[eventKey].sponsors !== undefined && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Sponsors Secured (from deals)
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={actuals[eventKey].sponsors || 0}
                                                        disabled
                                                        className="w-full px-4 py-2 border rounded-lg bg-gray-100 text-gray-600"
                                                    />
                                                </div>
                                            )}
                                            {actuals[eventKey] && actuals[eventKey].members !== undefined && (
                                                <div>
                                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                                        Members Signed Up
                                                    </label>
                                                    <input
                                                        type="number"
                                                        value={actuals[eventKey].members || 0}
                                                        onChange={(e) => setActuals({
                                                            ...actuals,
                                                            [eventKey]: {
                                                                ...actuals[eventKey],
                                                                members: parseInt(e.target.value) || 0
                                                            }
                                                        })}
                                                        className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                                                    />
                                                </div>
                                            )}
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Total Revenue (¬£)
                                                </label>
                                                <input
                                                    type="number"
                                                    value={actuals[eventKey]?.revenue || 0}
                                                    onChange={(e) => setActuals({
                                                        ...actuals,
                                                        [eventKey]: {
                                                            ...actuals[eventKey],
                                                            revenue: parseFloat(e.target.value) || 0
                                                        }
                                                    })}
                                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                                                    placeholder="Enter total revenue"
                                                />
                                            </div>
                                        </div>

                                        {/* Sponsorship Deals Section */}
                                        {SPONSOR_ELIGIBLE_EVENTS.includes(eventKey) && (
                                            <div className="mt-4 border-t pt-4">
                                                <div className="flex justify-between items-center mb-3">
                                                    <h4 className="font-semibold text-sm text-gray-700">Sponsorship Deals</h4>
                                                    <button
                                                        onClick={() => addDeal(eventKey)}
                                                        className="px-3 py-1 text-sm bg-purple-600 text-white rounded hover:bg-purple-700"
                                                    >
                                                        + Add Deal
                                                    </button>
                                                </div>
                                                {getDealsForEvent(eventKey).length > 0 ? (
                                                    <div className="space-y-2">
                                                        {getDealsForEvent(eventKey).map(deal => (
                                                            <div key={deal.id} className="flex items-center gap-2 bg-gray-50 p-2 rounded">
                                                                <input
                                                                    type="text"
                                                                    value={deal.company}
                                                                    onChange={(e) => updateDeal(deal.id, { company: e.target.value })}
                                                                    placeholder="Company name"
                                                                    className="flex-1 px-2 py-1 border rounded text-sm"
                                                                />
                                                                <div className="flex items-center gap-1">
                                                                    <span className="text-gray-500 text-sm">¬£</span>
                                                                    <input
                                                                        type="number"
                                                                        value={deal.amount || ''}
                                                                        onChange={(e) => updateDeal(deal.id, { amount: parseInt(e.target.value) || 0 })}
                                                                        placeholder="0"
                                                                        className="w-24 px-2 py-1 border rounded text-sm text-right"
                                                                    />
                                                                </div>
                                                                <select
                                                                    value={deal.status}
                                                                    onChange={(e) => updateDeal(deal.id, { status: e.target.value })}
                                                                    className={`px-2 py-1 border rounded text-sm font-medium ${
                                                                        deal.status === 'pipeline' ? 'bg-yellow-100 text-yellow-800' :
                                                                        deal.status === 'confirmed' ? 'bg-blue-100 text-blue-800' :
                                                                        'bg-green-100 text-green-800'
                                                                    }`}
                                                                >
                                                                    <option value="pipeline">Pipeline</option>
                                                                    <option value="confirmed">Confirmed</option>
                                                                    <option value="paid">Paid</option>
                                                                </select>
                                                                <button
                                                                    onClick={() => deleteDeal(deal.id)}
                                                                    className="px-2 py-1 text-red-500 hover:bg-red-50 rounded text-sm"
                                                                    title="Delete deal"
                                                                >
                                                                    ‚úï
                                                                </button>
                                                            </div>
                                                        ))}
                                                        {/* Summary row */}
                                                        {(() => {
                                                            const ss = getSponsorSummary(eventKey);
                                                            const confirmedAmount = getDealsForEvent(eventKey).filter(d => d.status === 'confirmed').reduce((s,d) => s+d.amount, 0);
                                                            const paidAmount = getDealsForEvent(eventKey).filter(d => d.status === 'paid').reduce((s,d) => s+d.amount, 0);
                                                            return (
                                                                <div className="flex justify-between items-center text-xs text-gray-600 pt-2 border-t mt-2">
                                                                    <div className="flex gap-3">
                                                                        <span className="text-yellow-700">Pipeline: {formatCurrency(ss.pipelineAmount)}</span>
                                                                        <span className="text-blue-700">Confirmed: {formatCurrency(confirmedAmount)}</span>
                                                                        <span className="text-green-700">Paid: {formatCurrency(paidAmount)}</span>
                                                                    </div>
                                                                    {ss.sponsorTarget > 0 && (
                                                                        <span className="font-medium">
                                                                            {formatCurrency(ss.securedAmount)} / {formatCurrency(ss.sponsorTarget)} target
                                                                        </span>
                                                                    )}
                                                                </div>
                                                            );
                                                        })()}
                                                    </div>
                                                ) : (
                                                    <p className="text-sm text-gray-400 italic">No deals yet. Click "Add Deal" to start tracking.</p>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {view === 'targets' && (
                            <div className="space-y-6">
                                <div className="bg-white rounded-lg shadow p-6">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-lg">Annual Revenue Targets (Editable)</h3>
                                        <button
                                            onClick={resetTargets}
                                            className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                                        >
                                            Reset to Defaults
                                        </button>
                                    </div>
                                    <div className="space-y-4">
                                        {Object.entries(targets).map(([key, value]) => (
                                            <div key={key} className="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                                <span className="font-medium w-64">{eventLabels[key]}:</span>
                                                <div className="flex items-center gap-2">
                                                    <span className="text-gray-600">¬£</span>
                                                    <input
                                                        type="number"
                                                        value={value.total}
                                                        onChange={(e) => updateTarget(key, 'total', e.target.value)}
                                                        className="w-40 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                                                    />
                                                    <span className="text-gray-600 ml-2">=</span>
                                                    <span className="font-bold text-purple-600 ml-2">{formatCurrency(value.total)}</span>
                                                </div>
                                            </div>
                                        ))}
                                        <div className="flex items-center gap-4 p-4 bg-purple-100 rounded-lg font-bold text-lg">
                                            <span className="w-64">Total Annual Target</span>
                                            <span className="text-purple-600">
                                                {formatCurrency(Object.values(targets).reduce((sum, t) => sum + t.total, 0))}
                                            </span>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                    <p className="text-sm text-yellow-800">
                                        <strong>üí° Tip:</strong> Changes to targets are saved automatically. Use "Reset to Defaults" to restore original values.
                                    </p>
                                </div>
                            </div>
                        )}

                        {view === 'settings' && (
                            <div className="space-y-6">
                                {/* Box Offices Management */}
                                <div className="bg-white rounded-lg shadow p-6">
                                    <h3 className="font-bold text-lg mb-4">Box Offices</h3>
                                    <p className="text-gray-600 mb-4">
                                        Add your Ticket Tailor box office accounts. Each account has its own API key.
                                        <a href="https://help.tickettailor.com/en/articles/4593218-how-do-i-connect-to-the-ticket-tailor-api"
                                           target="_blank"
                                           className="text-blue-600 hover:underline ml-2">
                                            How to get your API key
                                        </a>
                                    </p>

                                    {/* Existing box offices list */}
                                    {Object.values(boxOffices).length > 0 && (
                                        <div className="space-y-3 mb-6">
                                            {Object.values(boxOffices).map(bo => {
                                                const mappedCount = Object.values(eventMappings).filter(m => m && m.boxOfficeId === bo.id).length;
                                                return (
                                                    <div key={bo.id} className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                                                        <div>
                                                            <div className="font-semibold">{bo.name}</div>
                                                            <div className="text-sm text-gray-500">
                                                                Key: {bo.apiKey.substring(0, 8)}...{bo.apiKey.slice(-4)} | {mappedCount} event{mappedCount !== 1 ? 's' : ''} mapped
                                                            </div>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <button
                                                                onClick={async () => {
                                                                    try {
                                                                        setSyncError(null);
                                                                        await makeApiRequest('events', bo.apiKey);
                                                                        alert(`Connection to "${bo.name}" successful!`);
                                                                    } catch (e) {
                                                                        alert(`Connection failed: ${e.message}`);
                                                                    }
                                                                }}
                                                                className="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                                                            >
                                                                Test
                                                            </button>
                                                            <button
                                                                onClick={() => {
                                                                    if (confirm(`Delete "${bo.name}"? Events mapped to this box office will be unmapped.`)) {
                                                                        const updated = { ...boxOffices };
                                                                        delete updated[bo.id];
                                                                        setBoxOffices(updated);
                                                                        // Unmap any events pointing to this box office
                                                                        const newMappings = { ...eventMappings };
                                                                        for (const [k, m] of Object.entries(newMappings)) {
                                                                            if (m && m.boxOfficeId === bo.id) {
                                                                                newMappings[k] = null;
                                                                            }
                                                                        }
                                                                        setEventMappings(newMappings);
                                                                        setTtEventsByBoxOffice(prev => {
                                                                            const copy = { ...prev };
                                                                            delete copy[bo.id];
                                                                            return copy;
                                                                        });
                                                                    }
                                                                }}
                                                                className="px-3 py-1 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200"
                                                            >
                                                                Delete
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}

                                    {/* Add new box office form */}
                                    <div className="border-2 border-dashed border-gray-300 rounded-lg p-4">
                                        <h4 className="font-medium mb-3">Add New Box Office</h4>
                                        <div className="flex gap-2 items-end">
                                            <div className="flex-1">
                                                <label className="block text-sm text-gray-600 mb-1">Name</label>
                                                <input
                                                    type="text"
                                                    value={newBoName}
                                                    onChange={(e) => setNewBoName(e.target.value)}
                                                    placeholder="e.g. Ideas Fest Box Office"
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <div className="flex-1">
                                                <label className="block text-sm text-gray-600 mb-1">API Key</label>
                                                <input
                                                    type="password"
                                                    value={newBoKey}
                                                    onChange={(e) => setNewBoKey(e.target.value)}
                                                    placeholder="sk_xxxx_xxxx_xxxxxxxxxx"
                                                    className="w-full px-3 py-2 border rounded-lg"
                                                />
                                            </div>
                                            <button
                                                onClick={() => {
                                                    if (!newBoName.trim() || !newBoKey.trim()) return;
                                                    const id = 'bo_' + Date.now();
                                                    setBoxOffices({
                                                        ...boxOffices,
                                                        [id]: {
                                                            id,
                                                            name: newBoName.trim(),
                                                            platform: 'tickettailor',
                                                            apiKey: newBoKey.trim()
                                                        }
                                                    });
                                                    setNewBoName('');
                                                    setNewBoKey('');
                                                }}
                                                disabled={!newBoName.trim() || !newBoKey.trim()}
                                                className="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed"
                                            >
                                                Add
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                {/* CORS Proxy Settings */}
                                <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                                    <h3 className="font-bold text-lg mb-4">Connection Settings</h3>
                                    <p className="text-gray-700 mb-4">
                                        If you're getting CORS errors, enable the proxy below.
                                    </p>

                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3">
                                            <input
                                                type="checkbox"
                                                id="useProxy"
                                                checked={useProxy}
                                                onChange={(e) => setUseProxy(e.target.checked)}
                                                className="w-5 h-5"
                                            />
                                            <label htmlFor="useProxy" className="font-medium">
                                                Use CORS Proxy
                                            </label>
                                        </div>

                                        {useProxy && (
                                            <div>
                                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                                    Proxy URL:
                                                </label>
                                                <select
                                                    value={proxyUrl}
                                                    onChange={(e) => setProxyUrl(e.target.value)}
                                                    className="w-full px-4 py-2 border rounded-lg"
                                                >
                                                    <option value="vercel">Vercel Serverless (Recommended)</option>
                                                    <option value="https://corsproxy.io/?">corsproxy.io (May not work)</option>
                                                    <option value="https://api.allorigins.win/raw?url=">allorigins.win (May not work)</option>
                                                </select>
                                                <p className="text-xs text-gray-600 mt-2">
                                                    Public CORS proxies don't support Authorization headers. Use Vercel Serverless for best results.
                                                </p>
                                            </div>
                                        )}
                                    </div>
                                </div>

                                {/* Diagnostic Panel */}
                                {hasAnyBoxOffice && (
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                        <h3 className="font-bold text-lg mb-4">Configuration Status</h3>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between">
                                                <span>Box Offices:</span>
                                                <span className="font-semibold text-green-600">
                                                    {Object.keys(boxOffices).length} configured ({Object.values(boxOffices).map(b => b.name).join(', ')})
                                                </span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span>CORS Proxy:</span>
                                                <span className="font-semibold">
                                                    {useProxy ? `Enabled (${proxyUrl === 'vercel' ? 'Vercel Serverless' : proxyUrl})` : 'Disabled'}
                                                </span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span>Events Mapped:</span>
                                                <span className="font-semibold">
                                                    {Object.values(eventMappings).filter(m => m && m.eventId).length} / 6
                                                </span>
                                            </div>
                                            {Object.entries(eventMappings).filter(([_, m]) => m && m.eventId).map(([eventKey, m]) => (
                                                <div key={eventKey} className="flex justify-between pl-4 text-gray-600">
                                                    <span>{eventLabels[eventKey]}:</span>
                                                    <span>{boxOffices[m.boxOfficeId]?.name || 'Unknown'} / {m.eventId}</span>
                                                </div>
                                            ))}
                                            <div className="flex justify-between">
                                                <span>Last Sync:</span>
                                                <span className="font-semibold">
                                                    {lastSync ? new Date(lastSync).toLocaleString() : 'Never'}
                                                </span>
                                            </div>
                                        </div>
                                        <button
                                            onClick={() => {
                                                console.log('=== DIAGNOSTIC INFO ===');
                                                console.log('Box Offices:', boxOffices);
                                                console.log('Use Proxy:', useProxy);
                                                console.log('Proxy URL:', proxyUrl);
                                                console.log('Event Mappings:', eventMappings);
                                                console.log('TT Events by Box Office:', ttEventsByBoxOffice);
                                                console.log('Actuals:', actuals);
                                                console.log('Last Sync:', lastSync);
                                                alert('Diagnostic info logged to console. Press F12 to view.');
                                            }}
                                            className="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 w-full"
                                        >
                                            View Full Diagnostic Info
                                        </button>
                                    </div>
                                )}

                                {/* Event Mappings */}
                                {hasAnyBoxOffice && (
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <h3 className="font-bold text-lg mb-4">Event Mappings</h3>
                                        <p className="text-gray-600 mb-4">
                                            Map your Ticket Tailor events to Ideas Forums programs. Select a box office first, then choose the event.
                                        </p>

                                        <div className="flex gap-2 mb-4">
                                            {Object.values(boxOffices).map(bo => (
                                                <button
                                                    key={bo.id}
                                                    onClick={() => fetchEventsForBoxOffice(bo.id)}
                                                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm"
                                                >
                                                    Refresh "{bo.name}" Events
                                                </button>
                                            ))}
                                        </div>

                                        <div className="space-y-4">
                                            {['ideasFest', 'uksuaRegionals', 'uksuaNationals', 'gbea', 'gbia', 'fgi'].map(eventKey => {
                                                const mapping = eventMappings[eventKey];
                                                const selectedBoId = mapping?.boxOfficeId || '';
                                                const selectedEventId = mapping?.eventId || '';
                                                const eventsForBo = selectedBoId ? (ttEventsByBoxOffice[selectedBoId] || []) : [];

                                                return (
                                                    <div key={eventKey} className="flex items-center gap-3">
                                                        <label className="w-52 font-medium text-sm">{eventLabels[eventKey]}:</label>
                                                        <select
                                                            value={selectedBoId}
                                                            onChange={(e) => {
                                                                const boId = e.target.value;
                                                                setEventMappings({
                                                                    ...eventMappings,
                                                                    [eventKey]: boId ? { boxOfficeId: boId, eventId: '' } : null
                                                                });
                                                                // Auto-fetch events if we haven't yet
                                                                if (boId && !ttEventsByBoxOffice[boId]) {
                                                                    fetchEventsForBoxOffice(boId);
                                                                }
                                                            }}
                                                            className="flex-1 px-3 py-2 border rounded-lg text-sm"
                                                        >
                                                            <option value="">-- Box Office --</option>
                                                            {Object.values(boxOffices).map(bo => (
                                                                <option key={bo.id} value={bo.id}>{bo.name}</option>
                                                            ))}
                                                        </select>
                                                        <select
                                                            value={selectedEventId}
                                                            onChange={(e) => {
                                                                setEventMappings({
                                                                    ...eventMappings,
                                                                    [eventKey]: e.target.value
                                                                        ? { boxOfficeId: selectedBoId, eventId: e.target.value }
                                                                        : null
                                                                });
                                                            }}
                                                            disabled={!selectedBoId}
                                                            className="flex-1 px-3 py-2 border rounded-lg text-sm disabled:bg-gray-100"
                                                        >
                                                            <option value="">-- Select Event --</option>
                                                            {eventsForBo.map(event => (
                                                                <option key={event.id} value={event.id}>
                                                                    {event.name}
                                                                </option>
                                                            ))}
                                                        </select>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        {Object.values(ttEventsByBoxOffice).every(arr => arr.length === 0) && Object.keys(ttEventsByBoxOffice).length === 0 && (
                                            <div className="text-gray-500 italic mt-4">
                                                Click a "Refresh" button above to load events from your box offices
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<IdeasForumsDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
